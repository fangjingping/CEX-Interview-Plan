# 中间件与数据层手册（CTO 面试向）

## 目标
展示对消息系统、缓存与数据库一致性的深入理解，能描述失败模式与回退策略。

## 考核原则（CTO 视角）
- 能否说明选型理由、失败模式与可恢复路径。
- 能否把一致性边界、延迟与成本的取舍讲清楚。
- 能否用可观测指标验证方案有效性。

## 应用场景（CEX）
- 撮合结果的事件流（成交、订单变更、行情）。
- 幂等消费与回放（撮合/账本/行情）。
- 热点资产与热点用户的缓存治理。
- 订单与成交检索、审计与报表查询。

## 核心能力清单
- 消息系统：顺序性、幂等消费、重放、死信与延迟消息。
- Kafka/Pulsar：分区键设计、ISR、幂等生产、事务与 Exactly-once 取舍、日志压缩。
- Redis：缓存一致性、热点 Key、过期策略、分布式锁风险。
- 数据库：事务隔离级别、索引设计、读写分离、分库分表。
- ES：倒排索引、分片/副本、写入刷新与查询一致性。
- 数据治理：Schema Registry、Outbox/CDC、回放与补偿策略。

## 典型面试题与追问
必问
- Kafka 如何保证顺序与幂等？如何处理重复与乱序？
- 账本写入用什么隔离级别？如何降低锁冲突？
追问
- Rebalance 抖动如何治理？
- 缓存穿透/击穿如何处理？
- ES 索引设计如何平衡写入与查询性能？
- Outbox/CDC 如何保证业务与消息一致？

## 回答结构建议
先说明业务约束（顺序/一致性/延迟）→ 中间件选型 → 失败模式 → 监控与回滚。

## 常见陷阱
- 只谈配置参数，不谈故障场景。
- 只讲缓存命中率，不讲一致性与过期策略。
- ES 当成数据库使用，忽略刷新延迟与一致性语义。

## 演示关联
- 代码模块：`demo-middleware`
- 建议演示：幂等消费、分区顺序、Outbox/CDC、缓存 TTL、搜索刷新语义。
- 流程说明：`docs/INTEGRATION-FLOWS.md`

## 运维与演练清单（面试加分项）
- Kafka：分区 Lag、ISR 抖动、重放窗口、日志保留与压缩策略。
- Redis：热点 Key 识别、过期抖动治理、缓存穿透/击穿保护。
- 数据库：主从延迟监控、索引膨胀与慢查询治理、备份与回放窗口。
- ES：写入堆积与 refresh 队列、分片扩容与重建、冷热分层策略。

## 故障处理 Runbook（简版）
- 消费堆积：先隔离热点分区 → 扩消费者 → 降低下游写入压力 → 回放窗口评估。
- Outbox 堆积：检查事务提交与发布线程池 → 补偿发布 → 验证幂等去重。
- Rebalance 抖动：固定分区数与线程数 → 延迟加入 → 限制重试频率。
- 缓存穿透：布隆过滤/空对象缓存 → 降级读库 → 打散 TTL。

## 关键指标与告警
- 消息链路：生产/消费 TPS、99.9 延迟、分区 Lag、死信数量。
- 缓存：命中率、热 Key 次数、单键 QPS、内存水位。
- 数据库：慢查询数、锁等待、复制延迟、连接池耗尽率。
- ES：写入队列、refresh/merge 时间、查询 P95。
